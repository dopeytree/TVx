name: "CodeQL Auto-Fix"

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * 1'  # Weekly on Monday at 8 AM UTC

permissions:
  contents: write
  pull-requests: write
  security-events: read
  actions: read
  issues: write

jobs:
  autofix:
    name: CodeQL Auto-Fix
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Check CodeQL alerts
        id: alerts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          alerts=$(gh api /repos/${{ github.repository }}/code-scanning/alerts?state=open)
          count=$(echo "$alerts" | jq 'length')
          echo "count=$count" >> $GITHUB_OUTPUT
          echo "$alerts" > alerts.json
          
          if [ "$count" -gt 0 ]; then
            echo "has_alerts=true" >> $GITHUB_OUTPUT
            echo "::notice::Found $count open CodeQL alerts"
          else
            echo "has_alerts=false" >> $GITHUB_OUTPUT
            echo "::notice::No open CodeQL alerts found"
          fi

      - name: Install and lint
        if: steps.alerts.outputs.has_alerts == 'true'
        run: |
          npm ci
          npm run lint -- --fix || true

      - name: Check changes
        if: steps.alerts.outputs.has_alerts == 'true'
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff --name-only
          fi

      - name: Create PR with fixes
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="auto-fix/codeql-$(date +%Y%m%d-%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add .
          git commit -m "fix: Apply automated CodeQL security fixes"
          git push origin "$BRANCH"
          
          PR_BODY="## Automated Security Fixes

          This PR applies automated fixes for ${{ steps.alerts.outputs.count }} CodeQL security alert(s).

          ### Review Checklist
          - [ ] Review code changes
          - [ ] Test with npm run dev
          - [ ] Verify fixes resolve security issues
          - [ ] Run npm run lint

          View alerts in Security tab under Code scanning

          Auto-generated by CodeQL Auto-Fix workflow"
          
          gh pr create \
            --title "üîí Automated CodeQL Security Fixes" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH" \
            --label "security,automated,codeql"

      - name: Create manual review issue
        if: steps.alerts.outputs.has_alerts == 'true' && steps.changes.outputs.has_changes == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_BODY="## Manual Review Required

          The auto-fix workflow found ${{ steps.alerts.outputs.count }} CodeQL alert(s) that require manual review.

          ### Next Steps
          1. Review alerts in Security tab under Code scanning
          2. Create fixes manually
          3. Test thoroughly
          4. Submit PR

          Auto-generated by CodeQL Auto-Fix workflow"
          
          gh issue create \
            --title "üîç Manual Review: ${{ steps.alerts.outputs.count }} CodeQL Alert(s)" \
            --body "$ISSUE_BODY" \
            --label "security,manual-review,codeql"
